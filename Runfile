require "runfile-tasks"
require "byebug"
require_relative 'lib/madman'

title   "Madman Developer Toolbelt"
summary "Runfile tasks for building the Madman gem"
version Madman::VERSION

RunfileTasks::RubyGems.all 'madman'
RunfileTasks::Testing.rspec
RunfileTasks::Docs.rdoc

help   "Run YARD server"
action :yard do
  run "yard server -p3000 -B0.0.0.0 -r"
end

help   "Run interactive console"
action :console, :c do
  run "bundle exec bin/console"
end

help   "Generate TOC to toc.txt"
action :toc do
  run! 'gh-md-toc README.md > toc.txt'
end

help   "Generate changelog"
action :changelog do
  run 'github_changelog_generator --cache-file tmp/changlog-cache'  
  run "git commit -am 'update changelog' && git push"
end

help   "Inject usage to README"
action :usage do
  template = File.read 'README.md'
  commands = [
    "madman", 
    "madman render --help", 
    "madman preview --help", 
    "madman serve --help"
  ]
  marker = '<!-- usage -->'

  usage = [marker]
  commands.each do |command|
    say "Running #{command}..."
    usage << "```"
    usage << "$ #{command}"
    usage << `#{command}`.chomp
    usage << "```"
    usage << "\n---\n"
  end
  usage << marker

  usage = usage.join "\n"
  readme = template.gsub /#{marker}.*#{marker}/im, usage
  File.write 'README.md', readme
  say "Saved !txtgrn!README.md"  
end

help   "Count lines of code"
action :cloc do
  run "cloc . --exclude-dir coverage,spec,templates,tmp,dev --exclude-ext yml"
end

require_relative 'debug.rb' if File.exist? 'debug.rb'
